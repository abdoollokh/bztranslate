import asyncio
import logging
import os
import asyncpg
import stripe
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.types import (
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton, ReplyKeyboardRemove
)
from aiogram.client.default import DefaultBotProperties
from dotenv import load_dotenv

load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), '..', '.env'))

BOT_TOKEN = os.getenv("BOT_TOKEN")
DATABASE_URL = os.getenv("DATABASE_URL")
STRIPE_SECRET_KEY = os.getenv("STRIPE_SECRET_KEY")
stripe.api_key = STRIPE_SECRET_KEY

bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher(storage=MemoryStorage())
logging.basicConfig(level=logging.INFO)

async def get_db():
    return await asyncpg.connect(DATABASE_URL)

class RegState(StatesGroup):
    language = State()
    phone = State()
    full_name = State()

class OrderState(StatesGroup):
    choosing_date = State()
    waiting_date_input = State()

class SettingsState(StatesGroup):
    changing_name = State()
    changing_phone = State()
    changing_language = State()

def language_keyboard():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üá∫üáø O ªzbek", callback_data="lang_uz")],
        [InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru")]
    ])

def service_buttons(services, lang):
    buttons = [[
        InlineKeyboardButton(
            text=service["title_uz"] if lang == "uz" else service["title_ru"],
            callback_data=f"order_{service['id']}"
        )
    ] for service in services]
    buttons.append([
        InlineKeyboardButton(text="‚öôÔ∏è Sozlamalar" if lang == "uz" else "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="settings")
    ])
    return InlineKeyboardMarkup(inline_keyboard=buttons)

@dp.message(F.text == "/start")
async def cmd_start(message: types.Message, state: FSMContext):
    await state.clear()
    conn = await get_db()
    user = await conn.fetchrow("SELECT full_name, language FROM users WHERE telegram_id = $1", message.from_user.id)
    services = await conn.fetch("SELECT id, title_uz, title_ru FROM services")
    await conn.close()

    if user:
        lang = user["language"]
        name = user["full_name"]
        if not services:
            await message.answer({
                "uz": f"üëã Salom, {name}!\n‚úÖ Ro‚Äòyxatdan o‚Äòtgansiz.\n‚õî Xizmatlar yo‚Äòq.",
                "ru": f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n‚úÖ –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n‚õî –£—Å–ª—É–≥–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            }[lang])
            return
        text = {
            "uz": f"üëã Salom, {name}!\nüìã Xizmatlar ro‚Äòyxati:",
            "ru": f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\nüìã –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥:"
        }[lang]
        await message.answer(text, reply_markup=service_buttons(services, lang))
    else:
        await message.answer("Tilni tanlang:\n–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:", reply_markup=language_keyboard())
        await state.set_state(RegState.language)

@dp.callback_query(F.data.startswith("lang_"))
async def update_lang(callback: types.CallbackQuery, state: FSMContext):
    lang = callback.data.split("_")[1]
    await state.update_data(language=lang)
    btn_text = {"uz": "üì± Raqamni yuborish", "ru": "üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä"}[lang]
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=btn_text, request_contact=True)]],
        resize_keyboard=True, one_time_keyboard=True
    )
    msg = {"uz": "üìû Telefon raqamingizni yuboring:", "ru": "üìû –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä:"}[lang]
    await callback.message.answer(msg, reply_markup=kb)
    await state.set_state(RegState.phone)
    await callback.answer()

@dp.message(F.contact)
async def handle_contact(message: types.Message, state: FSMContext):
    current = await state.get_state()
    if current == RegState.phone.state:
        data = await state.get_data()
        lang = data.get("language", "uz")
        phone = message.contact.phone_number
        if phone.startswith("+1") or phone.startswith("1"):
            normalized = "+1" + phone[-10:]
            await state.update_data(phone=normalized)
            await message.answer({
                "uz": "üìù Ismingizni kiriting:",
                "ru": "üìù –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è:"
            }[lang], reply_markup=ReplyKeyboardRemove())
            await state.set_state(RegState.full_name)
        else:
            await message.answer({
                "uz": "‚ùó Faqat AQSH raqamlari qabul qilinadi.",
                "ru": "‚ùó –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä–∞ –°–®–ê."
            }[lang])
@dp.message()
async def handle_text_messages(message: types.Message, state: FSMContext):
    current = await state.get_state()

    # 1. Ro‚Äòyxatdan o‚Äòtishda matn orqali raqam
    if current == RegState.phone.state:
        phone = message.text.strip().replace(" ", "").replace("-", "").replace("(", "").replace(")", "")
        data = await state.get_data()
        lang = data.get("language", "uz")
        if phone.startswith("+1") and len(phone) == 12 and phone[2:].isdigit():
            normalized = phone
        elif phone.isdigit() and len(phone) == 10:
            normalized = "+1" + phone
        else:
            await message.answer({
                "uz": "‚ùó Raqam noto‚Äòg‚Äòri formatda. Masalan: <code>3479974017</code> yoki <code>+13479974017</code>",
                "ru": "‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä: <code>3479974017</code> –∏–ª–∏ <code>+13479974017</code>"
            }[lang], parse_mode="HTML")
            return
        await state.update_data(phone=normalized)
        await message.answer({
            "uz": "üìù Ismingizni kiriting:",
            "ru": "üìù –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è:"
        }[lang], reply_markup=ReplyKeyboardRemove())
        await state.set_state(RegState.full_name)
        return

    # 2. Sozlamalarda matn orqali raqamni o‚Äòzgartirish
    if current == SettingsState.changing_phone.state:
        phone = message.text.strip().replace(" ", "").replace("-", "").replace("(", "").replace(")", "")
        conn = await get_db()
        lang = await conn.fetchval("SELECT language FROM users WHERE telegram_id = $1", message.from_user.id)
        await conn.close()
        if phone.startswith("+1") and len(phone) == 12 and phone[2:].isdigit():
            formatted = phone
        elif phone.isdigit() and len(phone) == 10:
            formatted = "+1" + phone
        else:
            await message.answer({
                "uz": "‚ùó Raqam noto‚Äòg‚Äòri formatda.",
                "ru": "‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞."
            }[lang])
            return
        conn = await get_db()
        await conn.execute("UPDATE users SET phone_number = $1 WHERE telegram_id = $2", formatted, message.from_user.id)
        await conn.close()
        text, kb = await settings_text_and_kb(message.from_user.id)
        await message.answer({
            "uz": "‚úÖ Raqam yangilandi.\n\n" + text,
            "ru": "‚úÖ –ù–æ–º–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω.\n\n" + text
        }[lang], reply_markup=kb, parse_mode="HTML")
        await state.clear()
        return

    # 3. Ism kiritish (ro‚Äòyxatdan o‚Äòtishda)
    if current == RegState.full_name.state:
        full_name = message.text.strip()
        data = await state.get_data()
        phone = data["phone"]
        language = data["language"]
        telegram_id = message.from_user.id
        conn = await get_db()
        await conn.execute("""
            INSERT INTO users (full_name, phone_number, language, telegram_id)
            VALUES ($1, $2, $3, $4)
            ON CONFLICT (phone_number) DO UPDATE SET telegram_id = EXCLUDED.telegram_id
        """, full_name, phone, language, telegram_id)
        services = await conn.fetch("SELECT id, title_uz, title_ru FROM services")
        await conn.close()
        if not services:
            await message.answer({
                "uz": f"üëã Salom, {full_name}!\n‚úÖ Ro‚Äòyxatdan o‚Äòtdingiz.\n‚õî Hozircha xizmatlar yo‚Äòq.",
                "ru": f"üëã –ü—Ä–∏–≤–µ—Ç, {full_name}!\n‚úÖ –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.\n‚õî –£—Å–ª—É–≥–∏ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."
            }[language])
            return
        buttons = [[
            InlineKeyboardButton(
                text=service["title_uz"] if language == "uz" else service["title_ru"],
                callback_data=f"order_{service['id']}"
            )
        ] for service in services]
        buttons.append([
            InlineKeyboardButton(
                text="‚öôÔ∏è Sozlamalar" if language == "uz" else "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                callback_data="settings"
            )
        ])
        await message.answer({
            "uz": f"üëã Salom, {full_name}!\nüìã Xizmatlar ro‚Äòyxati:",
            "ru": f"üëã –ü—Ä–∏–≤–µ—Ç, {full_name}!\nüìã –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥:"
        }[language], reply_markup=InlineKeyboardMarkup(inline_keyboard=buttons))
        await state.clear()

@dp.callback_query(F.data.startswith("order_"))
async def handle_order(callback: types.CallbackQuery, state: FSMContext):
    service_id = int(callback.data.split("_")[1])
    conn = await get_db()
    lang = await conn.fetchval("SELECT language FROM users WHERE telegram_id = $1", callback.from_user.id)
    await conn.close()

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìÖ Bugun" if lang == "uz" else "üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data=f"date_today_{service_id}")],
        [InlineKeyboardButton(text="üìÜ Ertaga" if lang == "uz" else "üìÜ –ó–∞–≤—Ç—Ä–∞", callback_data=f"date_tomorrow_{service_id}")],
        [InlineKeyboardButton(text="üìñ Boshqa kun" if lang == "uz" else "üìñ –î—Ä—É–≥–∞—è –¥–∞—Ç–∞", callback_data=f"date_other_{service_id}")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Ortga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_services")]
    ])
    await callback.message.edit_text({
        "uz": "üìÖ Qachon kerak?",
        "ru": "üìÖ –ù–∞ –∫–∞–∫–æ–π –¥–µ–Ω—å –Ω—É–∂–Ω–æ?"
    }[lang], reply_markup=kb)
    await callback.answer()

@dp.callback_query(F.data.startswith("date_"))
async def handle_date(callback: types.CallbackQuery, state: FSMContext):
    parts = callback.data.split("_")
    date_type = parts[1]
    service_id = int(parts[2])

    conn = await get_db()
    user = await conn.fetchrow("SELECT id, language FROM users WHERE telegram_id = $1", callback.from_user.id)
    service = await conn.fetchrow("SELECT * FROM services WHERE id = $1", service_id)
    conn.close()

    lang = user["language"]
    user_id = user["id"]

    if date_type == "today":
        selected_date = datetime.now().date()
    elif date_type == "tomorrow":
        selected_date = datetime.now().date() + timedelta(days=1)
    else:
        await state.update_data(service_id=service_id)
        await state.set_state(OrderState.waiting_date_input)
        await callback.message.edit_text({
            "uz": "üìÖ Sanani kiriting (YYYY-MM-DD):",
            "ru": "üìÖ –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É (YYYY-MM-DD):"
        }[lang])
        return

    session = stripe.checkout.Session.create(
        payment_method_types=["card"],
        line_items=[{
            "price_data": {
                "currency": "usd",
                "product_data": {
                    "name": service["title_uz"] if lang == "uz" else service["title_ru"]
                },
                "unit_amount": int(service["price_usd"] * 100),
            },
            "quantity": 1,
        }],
        mode="payment",
        success_url="https://t.me/bztesterbot",  # o‚Äòzgartiring
        cancel_url="https://t.me/bztesterbot",
        metadata={
            "user_id": str(user_id),
            "service_id": str(service_id),
            "date": str(selected_date)
        }
    )

    text = {
        "uz": f"üßæ Xizmat: {service['title_uz']}\nüìÜ Sana: {selected_date}\nüíµ Narx: ${service['price_usd']}\n\nüí≥ To‚Äòlov uchun tugmani bosing:",
        "ru": f"üßæ –£—Å–ª—É–≥–∞: {service['title_ru']}\nüìÜ –î–∞—Ç–∞: {selected_date}\nüíµ –¶–µ–Ω–∞: ${service['price_usd']}\n\nüí≥ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã:"
    }[lang]

    pay_kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí≥ To‚Äòlov qilish" if lang == "uz" else "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=session.url)],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Ortga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_services")]
    ])

    await callback.message.edit_text(text, reply_markup=pay_kb)
    await state.clear()

@dp.message(OrderState.waiting_date_input)
async def handle_custom_date(message: types.Message, state: FSMContext):
    try:
        selected_date = datetime.strptime(message.text.strip(), "%Y-%m-%d").date()
    except:
        await message.answer("‚ùó Format noto‚Äòg‚Äòri. Masalan: 2025-07-01")
        return

    data = await state.get_data()
    service_id = data["service_id"]

    # bu yerda siz Stripe sessiya yaratishni takrorlasangiz bo‚Äòladi yoki xabar berish bilan to‚Äòxtab tursangiz ham bo‚Äòladi
    await message.answer(f"‚úÖ Sana qabul qilindi: {selected_date}")
    await state.clear()

@dp.callback_query(F.data == "back_to_services")
async def back_to_services(callback: types.CallbackQuery, state: FSMContext):
    conn = await get_db()
    user = await conn.fetchrow("SELECT full_name, language FROM users WHERE telegram_id = $1", callback.from_user.id)
    services = await conn.fetch("SELECT id, title_uz, title_ru FROM services")
    await conn.close()
    lang = user["language"]
    name = user["full_name"]
    await callback.message.edit_text({
        "uz": f"üëã Salom, {name}!\nüìã Xizmatlar ro‚Äòyxati:",
        "ru": f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\nüìã –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥:"
    }[lang], reply_markup=service_buttons(services, lang))
    await state.clear()

@dp.callback_query(F.data == "settings")
async def show_settings(callback: types.CallbackQuery, state: FSMContext):
    text, kb = await settings_text_and_kb(callback.from_user.id)
    await callback.message.edit_text(text, reply_markup=kb, parse_mode="HTML")
    await callback.answer()

@dp.callback_query(F.data == "change_name")
async def change_name(callback: types.CallbackQuery, state: FSMContext):
    conn = await get_db()
    lang = await conn.fetchval("SELECT language FROM users WHERE telegram_id = $1", callback.from_user.id)
    await conn.close()
    await callback.message.edit_text({
        "uz": "üë§ Yangi ismingizni kiriting:",
        "ru": "üë§ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:"
    }[lang])
    await state.set_state(SettingsState.changing_name)
    await callback.answer()

@dp.message(SettingsState.changing_name)
async def save_name(message: types.Message, state: FSMContext):
    full_name = message.text.strip()
    conn = await get_db()
    await conn.execute("UPDATE users SET full_name = $1 WHERE telegram_id = $2", full_name, message.from_user.id)
    lang = await conn.fetchval("SELECT language FROM users WHERE telegram_id = $1", message.from_user.id)
    await conn.close()
    text, kb = await settings_text_and_kb(message.from_user.id)
    await message.answer({
        "uz": "‚úÖ Ism yangilandi.\n\n" + text,
        "ru": "‚úÖ –ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ.\n\n" + text
    }[lang], reply_markup=kb, parse_mode="HTML")
    await state.clear()

@dp.callback_query(F.data == "change_lang")
async def change_lang(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(SettingsState.changing_language)
    await callback.message.edit_text("üåê Tilni tanlang:\n–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:", reply_markup=language_keyboard())
    await callback.answer()

@dp.callback_query(F.data.startswith("lang_"))
async def update_lang(callback: types.CallbackQuery, state: FSMContext):
    lang = callback.data.split("_")[1]
    current = await state.get_state()
    if current == SettingsState.changing_language.state:
        conn = await get_db()
        await conn.execute("UPDATE users SET language = $1 WHERE telegram_id = $2", lang, callback.from_user.id)
        await conn.close()
        text, kb = await settings_text_and_kb(callback.from_user.id)
        await callback.message.edit_text({
            "uz": "‚úÖ Til o‚Äòzgartirildi.\n\n" + text,
            "ru": "‚úÖ –Ø–∑—ã–∫ –∏–∑–º–µ–Ω—ë–Ω.\n\n" + text
        }[lang], reply_markup=kb, parse_mode="HTML")
        await state.clear()
    else:
        # yangi foydalanuvchi ro‚Äòyxatdan o‚Äòtmoqda
        await state.update_data(language=lang)
        ...

@dp.callback_query(F.data == "change_phone")
async def change_phone(callback: types.CallbackQuery, state: FSMContext):
    conn = await get_db()
    lang = await conn.fetchval("SELECT language FROM users WHERE telegram_id = $1", callback.from_user.id)
    await conn.close()
    msg = {"uz": "üìû Yangi raqamingizni yuboring:", "ru": "üìû –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä:"}[lang]
    btn = {"uz": "üì± Raqamni yuborish", "ru": "üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä"}[lang]
    kb = ReplyKeyboardMarkup(
        keyboard=[[KeyboardButton(text=btn, request_contact=True)]],
        resize_keyboard=True, one_time_keyboard=True
    )
    await callback.message.answer(msg, reply_markup=kb)
    await state.set_state(SettingsState.changing_phone)
    await callback.answer()


async def settings_text_and_kb(telegram_id: int):
    conn = await get_db()
    user = await conn.fetchrow("SELECT full_name, phone_number, language FROM users WHERE telegram_id = $1", telegram_id)
    await conn.close()
    lang = user["language"]
    text = {
        "uz": (
            f"‚öôÔ∏è <b>Sozlamalar</b>\n\n"
            f"üë§ Ism: {user['full_name']}\n"
            f"üìû Raqam: {user['phone_number']}\n"
            f"üåê Til: {'O‚Äòzbek tili' if lang == 'uz' else '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫'}\n\n"
            "Nimani o‚Äòzgartirmoqchisiz?"
        ),
        "ru": (
            f"‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>\n\n"
            f"üë§ –ò–º—è: {user['full_name']}\n"
            f"üìû –ù–æ–º–µ—Ä: {user['phone_number']}\n"
            f"üåê –Ø–∑—ã–∫: {'O‚Äòzbek tili' if lang == 'uz' else '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫'}\n\n"
            "–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å?"
        )
    }[lang]

    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üåê Tilni o‚Äòzgartirish" if lang == "uz" else "üåê –ò–∑–º–µ–Ω–∏—Ç—å —è–∑—ã–∫", callback_data="change_lang")],
        [InlineKeyboardButton(text="üë§ Ismni o‚Äòzgartirish" if lang == "uz" else "üë§ –ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è", callback_data="change_name")],
        [InlineKeyboardButton(text="üìû Raqamni o‚Äòzgartirish" if lang == "uz" else "üìû –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä", callback_data="change_phone")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Ortga" if lang == "uz" else "‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_services")]
    ])
    return text, kb

if __name__ == "__main__":
    asyncio.run(dp.start_polling(bot))
